<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checkout Requests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/css/Admin/rented.css" />
    <script>
        function redirectToDetails(bookingId) {
            window.location.href = `/admin/booking_details?bookingId=${bookingId}`;
        }
    </script>
</head>

<body>
    <nav class="navbar navbar-expand-lg fixed-top bg-dark">
        <a class="navbar-brand text-white" href="/admin">NileWay</a>
        <div class="collapse navbar-collapse justify-content-center" id="navbarSupportedContent">
            <ul class="navbar-nav">
                <li class="nav-item px-4"><a class="nav-link text-white" href="#">Inventory</a></li>
                <li class="nav-item px-4"><a class="nav-link text-white" href="#">Status</a></li>
                <li class="nav-item px-4"><a class="nav-link text-white" href="#">Bookings</a></li>
            </ul>
        </div>
        <form class="d-flex me-4">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"/>
            <button class="btn btn-outline-light" type="submit">Search</button>
        </form>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <div class="row">
            <div class="col-12 mb-4">
                <h2>Checkout Requests</h2>
                <p class="text-muted">Total requests: <%= requests.length %></p>
            </div>
            
            <% if (requests.length === 0) { %>
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <h4>No checkout requests found</h4>
                        <p>When customers complete the checkout process, their requests will appear here.</p>
                    </div>
                </div>
            <% } else { %>
                <% requests.forEach(request => { %>
                    <div class="col-12 card p-3 mb-3" onclick="redirectToDetails('<%= request._id %>')" style="cursor: pointer;">
                        <div class="d-flex justify-content-between">
                            <div class="d-flex">
                                <!-- Identity Document Image -->
                                <div class="me-3">
                                    <% if (request.identityImage) { %>
                                        <img src="<%= request.identityImage %>" 
                                             alt="Identity Document" 
                                             style="width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #007bff;">
                                        <small class="d-block text-center text-muted mt-1">ID Document</small>
                                    <% } else { %>
                                        <div style="width: 120px; height: 80px; background-color: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-id-card text-muted"></i>
                                        </div>
                                        <small class="d-block text-center text-muted mt-1">No ID</small>
                                    <% } %>
                                </div>
                                <!-- Customer Details -->
                                <div>
                                    <div><strong>Car:</strong> <%= request.carName || "Not specified" %></div>
                                    <div class="mt-1"><strong>Customer:</strong> <%= request.fullname || "No name" %></div>
                                <div class="mt-1"><strong>Email:</strong> <%= request.email || "No email" %></div>
                                <div class="mt-1"><strong>Phone:</strong> <%= request.phone || "No phone" %></div>
                                    <div class="mt-2">
                                        <strong>Pickup:</strong> <%= request.pickupDate || "Not specified" %> |
                                        <strong>Return:</strong> <%= request.returnDate || "Not specified" %> |
                                        <strong>Location:</strong> <%= request.pickupLocation || "Not specified" %>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div style="margin-right: 10px;">
                                    <strong>Booking ID:</strong> <%= request.bookingReference || request._id %>
                                </div>
                                <div class="mt-1">
                                    <strong>Total:</strong> $<%= request.totalAmount || 0 %>
                                </div>
                                <div class="mt-1">
                                    <strong>Payment:</strong> <%= request.paymentMethod || "Not specified" %>
                                </div>
                                <div class="mt-1">
                                    <strong>Status:</strong> 
                                    <span class="badge bg-<%= request.status === 'confirmed' ? 'success' : request.status === 'pending' ? 'warning' : 'secondary' %>">
                                        <%= request.status || 'pending' %>
                                    </span>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <%= request.dateCreated ? new Date(request.dateCreated).toLocaleDateString() : 'No date' %>
                                    </small>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-success btn-sm me-2" onclick="event.stopPropagation(); updateStatus('<%= request._id %>', 'confirmed')">Approve</button>
                                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); updateStatus('<%= request._id %>', 'cancelled')">Decline</button>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            <% } %>
        </div>
    </div>

    <script>
        function updateStatus(bookingId, status) {
            if (confirm(`Are you sure you want to ${status} this booking?`)) {
                fetch(`/admin/booking/${bookingId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: status })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        alert(`Booking ${status} successfully`);
                        // Reload the page to show updated status
                        location.reload();
                    } else {
                        alert('Error updating status: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating status');
                });
            }
        }
    </script>
</body>
</html>
