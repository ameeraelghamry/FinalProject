<!-- Cookie Consent System - NileWay Rentals -->
<!-- This partial includes all cookie-related functionality -->

<!-- Cookie CSS Styles -->
<link rel="stylesheet" href="/css/cookies.css">

<!-- Only show cookie banner and modal on home page, but load scripts everywhere -->
<% if (typeof isHomePage !== 'undefined' && isHomePage) { %>
    <!-- Cookie Consent Banner and Modal HTML -->
    <%- include('../cookie-consent') %>
<% } %>

<!-- Cookie Analytics Template (loads conditionally) -->
<%- include('../cookie-analytics') %>

<!-- Cookie Management Scripts - Load on all pages for consent persistence -->
<script src="/JavaScript/cookies.js"></script>
<script src="/JavaScript/cookieConsent.js"></script>
<script src="/JavaScript/cookie-analytics.js"></script>
<script src="/JavaScript/analytics-example.js"></script>

<!-- Integration Script - Ensures everything works together -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isHomePage = window.location.pathname === '/' || window.location.pathname === '/home';
    
    console.log('ðŸª Cookie system integration check:');
    console.log('ðŸ“ Current page:', window.location.pathname);
    console.log('ðŸ  Is home page:', isHomePage);
    
    // Check if main cookie manager is loaded
    if (window.CookieConsentManager) {
        console.log('âœ… CookieConsentManager loaded');
    } else {
        console.error('âŒ CookieConsentManager not loaded');
    }
    
    // Check if cookie utilities are available
    if (window.cookieConsentUtils) {
        console.log('âœ… Cookie utilities loaded');
    } else {
        console.error('âŒ Cookie utilities not loaded');
    }
    
    // Check if analytics system is available
    if (window.CookieAnalytics) {
        console.log('âœ… CookieAnalytics class loaded');
    } else {
        console.error('âŒ CookieAnalytics class not loaded');
    }
    
    // Check if car rental analytics functions are available
    if (window.carRentalAnalytics) {
        console.log('âœ… Car rental analytics loaded');
    } else {
        console.error('âŒ Car rental analytics not loaded');
    }
    
    // Set up integration event listeners
    window.addEventListener('cookieConsentApplied', function(event) {
        const consent = event.detail;
        console.log('ðŸ”„ Cookie consent updated:', consent);
        
        // Ensure analytics system responds to consent changes
        if (consent.analytics && window.cookieAnalytics) {
            console.log('ðŸ“Š Analytics enabled via consent update');
        } else if (!consent.analytics && window.cookieAnalytics) {
            console.log('ðŸš« Analytics disabled via consent update');
        }
    });
    
    // If not on home page, check for existing consent and apply it
    if (!isHomePage) {
        const existingConsent = localStorage.getItem('cookieConsent');
        if (existingConsent) {
            try {
                const consentData = JSON.parse(existingConsent);
                console.log('ðŸ“‹ Applying existing consent on non-home page:', consentData.consentData);
                
                // Apply existing consent settings without showing banner
                if (window.cookieConsent && window.cookieConsent.applyConsentSettings) {
                    window.cookieConsent.applyConsentSettings(consentData.consentData);
                }
            } catch (error) {
                console.error('Error applying existing consent:', error);
            }
        }
    }
    
    console.log('ðŸŽ‰ Cookie system integration complete');
});

// Global function to open cookie preferences from any page
window.openCookiePreferences = function() {
    if (window.cookieConsent && window.cookieConsent.showPreferencesModal) {
        window.cookieConsent.showPreferencesModal();
    } else {
        // If on non-home page, redirect to home with preferences flag
        const url = new URL(window.location.origin);
        url.searchParams.set('openCookiePreferences', 'true');
        window.location.href = url.toString();
    }
};

// Handle opening preferences if redirected from another page
if (window.location.search.includes('openCookiePreferences=true')) {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            if (window.openCookiePreferences) {
                window.openCookiePreferences();
            }
        }, 1000);
    });
}
</script> 